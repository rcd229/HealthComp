<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="format-detection" content="telephone=no" />
  <meta name="msapplication-tap-highlight" content="no" />
  <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
  <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
  <title>Mindependence | Login</title>
  <link rel="stylesheet" type="text/css" href="css/style.css" />
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
  <script type="text/javascript" src="js/user.js"></script>
  <script type="text/javascript" src="js/menu.js"></script>

  <script>
  var user;
  var date;

  function greeting() {
  	var username = "";
  	if(typeof(Storage) !== "undefined") {
  		if (localStorage.user == undefined) {
  			username = "undefined user";
  		}
  		else {
  			user = new User();
  			user.fromString(localStorage.user);
        console.log(user);
  			username = user.getUsername();

        //start background worker
        if (!!window.SharedWorker) {
          var worker = new SharedWorker("js/backgroundNotification.js");
          worker.port.addEventListener("message", function(e) {
            console.log(e.data);
          }, false);
          worker.port.start();
          worker.port.postMessage(user.getToday());

          worker.port.onmessage = function(e) {
            console.log('Message received from worker');
            console.log(e.data);
          }
        }
        else {
          alert("So basically we're screwed because we can't do notifications idk");
        }
  		}
  		var greeting;
  		date = new Date();
  		var time = date.getHours();
  		if (time < 10) {
  			greeting = "Good morning";
  		} else if (time < 20) {
  			greeting = "Good day";
  		} else {
  			greeting = "Good evening";
  		}
	  	document.getElementById("greeting").innerHTML = greeting + ", " + username + "!";
	  	getToday();
	  	getLocation();

    } else {
    alert("Well this didn't work...");
    }
  }

function getToday() {
	var count = 0;
	if (user != undefined) {
		var month = date.getMonth();
		var day = date.getDate();
		var year = date.getFullYear();
    var dayofweek = date.getDay();
		console.log("" + month + " " + day + " " + year);
		var reminders = user.getAllCategories();
    console.log("reminders");
    console.log(reminders);
		for (var i = 0; i < reminders.length; i++) {
			var remdate = reminders[i].getDate();
			if ((remdate[0] == month && remdate[1] == day && remdate[2] == year) || reminders[i].getRepeat().indexOf(dayofweek.toString()) != -1 || reminders[i].getRepeat().indexOf("Daily") != -1) {
				var remtoday = addTodayRem(reminders[i]);
				document.getElementById("today").innerHTML = document.getElementById("today").innerHTML + remtoday;
				count++; 
			}
		}
	}
	if (count == 0) {
		document.getElementById("today").innerHTML = document.getElementById("today").innerHTML + "<div class=\"no-rem\">No reminders today!</div>";
	}

}

function addTodayRem(reminder){
  var remdiv = "<div class=\"listed-reminder\"><button class=\"main\">";
  var remimg = "<img src=" + reminder.getPicture() + ">";
  var remtitle = "<div class=\"list-item\"><div class=\"list-title\">" + reminder.getTitle() + "</div>";
  var remtime = "<div class=\"list-time\">" + reminder.timeToString() + "</div></div>";
  var remove = "<div class=\"list-buttons\"><a id=\"remove\"><img src=\"img/delete.png\"></a>";
  var dismiss = "<a id=\"dismiss\"><img src=\"img/done.png\"></a></div>";
  remdiv = remdiv + remimg + remtitle + remtime + remove + dismiss + "</button></div>";
  return remdiv;
}

function getLocation() {
	if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, showError);
    } else {
        document.getElementById("location-home").innerHTML = "Geolocation is not supported by this browser.";
    }

}

function showPosition(position) {
    var latlon = position.coords.latitude + "," + position.coords.longitude;

    var img_url = "http://maps.googleapis.com/maps/api/staticmap?center="
    +latlon+"&zoom=14&size=400x300&sensor=false";
    document.getElementById("location-home").innerHTML = "<img src='"+img_url+"'>";
}

function showError(error) {
    switch(error.code) {
        case error.PERMISSION_DENIED:
            document.getElementById("location-home").innerHTML = "User denied the request for Geolocation."
            break;
        case error.POSITION_UNAVAILABLE:
            document.getElementById("location-home").innerHTML = "Location information is unavailable."
            break;
        case error.TIMEOUT:
            document.getElementById("location-home").innerHTML = "The request to get user location timed out."
            break;
        case error.UNKNOWN_ERROR:
            document.getElementById("location-home").innerHTML = "An unknown error occurred."
            break;
    }
}

</script>

<script>
$( document ).ready(function() {
	//get user greeting
	greeting();

  $('#logout').click(function() {
  console.log("logged out");
  if(typeof(Storage) !== "undefined") {
      if (localStorage.user != undefined) {
        //localStorage.removeItem("user");
      }
    }
  else {
    alert('lol...');
  }
  setTimeout(function() {
    window.location.href = "index.html"
  },2000);
});
});

</script>
</head>

<body>
  <div id="container">
  	<div id="navwrap">
  		<div id="navbg">
	  		<div class="menu-toggle">
	  			<a href="#"><img src="img/menu.png"></a>
	  			<div id="menu-option" style="display: none;">open</div>
	  		</div>
	  		<div id="greeting"></div>
	  		<div class="add">
	  			<a href="addReminder.html"><img src="img/plus-icon.png"></a>
	  		</div>
	  	</div>
	</div>
	<div id="navdiv">
		<nav class="main">
			<ul id="navul" class="grid full" style="display: none;">
				<li id="myProfile" class="profile">
          <a href="userHomeScreen.html"><img class="menu-icon" src="img/profile.png">Me</a>
        </li>
				<li id="myLocation">
          <a href="location.html"><img class="menu-icon" src="img/location.png">My Location</a>
        </li>
				<li id="myAlarms" class="reminder">
          <a href="alarmPage.html"><img class="menu-icon" src="img/alarm.png">My Alarms</a>
        </li>
				<li id="myTasks" class="reminder">
          <a href="taskPage.html"><img class="menu-icon" src="img/task.png">My Tasks</a>
        </li>
				<li id="myTasks" class="reminder">
          <a href="eventPage.html"><img class="menu-icon" src="img/event.png">My Events</a>
        </li>
				<li id="myTasks" class="reminder">
          <a href="otherPage.html"><img class="menu-icon" src="img/other.png">Other Reminders</a>
        </li>
				<li id="logout">
          <a href="#" onclick="logout()"><img class="menu-icon" src="img/logout.png">Logout</a>
        </li>
			</ul>
		</nav>
	</div>
  <div id="content">	
		<div id="today">
			<div class="heading">Today</div>
		</div>
		<div id="location-home"></div>
    <div id="home-buttons">
      <div class="grid-fourth">
        <a href="alarmPage.html">
        <img class="menu-icon-large" src="img/alarm.png">
        <div class="button-label">My Alarms</div>
        </a>
      </div>
      <div class="grid-fourth">
        <a href="taskPage.html">
          <img class="menu-icon-large" src="img/task.png">
          <div class="button-label">My Tasks</div>
        </a>
      </div>
      <div class="button-center">
        <a href="addReminder.html">
          <img class="menu-icon-large" src="img/plus-icon.png">
          <div class="button-label">Add a Reminder</div>
        </a>
      </div>
       <div class="grid-fourth">
        <a href="eventPage.html">
          <img class="menu-icon-large" src="img/event.png">
          <div class="button-label">My Events</div>
        </a>
      </div>
      <div class="grid-fourth button-last">
        <a href="otherPage.html">
          <img class="menu-icon-large" src="img/other.png">
          <div class="button-label">Other Reminders</div>
        </a>
      </div>
    </div>
	</div>
  </div>
<!--<script src="phonegap.js"></script>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/index.js"></script>-->
</body>
</html>